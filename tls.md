# 网络安全通信

我曾经和大部分互联网用户一样，觉得互联网安全问题总是处在社会和法律控制
的范围里，互联网以和谐为主旋律。在学习 TLS 的过程中，才发现这和谐都是
互联网公司给人的错觉，真实的互联网就是一个Sin City。如果互联网用户不了
解 TLS 这样的网络安全技术，就像一个全裸美女露宿在贼窝里一样脆弱。TLS就
像美女包包里的避孕套和枪一样——希望永远也用不上，但是当需要用的时候，一
定得会用。


## 加密技术

通常有两种加密技术：对称加密（symmetric encryption）和非对称加密
（asymmetric encryption）。

### 对称加密

对称加密的一方（比如小红）用秘钥 K 给文本 M 加密；另一方（比如小明）用
同一个秘钥解密：

```
小红 : C = E(M, K)
小明 : M = D(C, K)
```

这有一个问题：一方生成秘钥 K 之后得把 K 给另一方。但是穿越 Sin City 的
道路危险，中途要是有人窃听到 K，将来就可以假装双方中的任何一方与另一方
通信。这叫
**[中间人攻击（man-in-the-middle attack）](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)**
。


### 非对称加密

非对称加密有一对儿两个秘钥：K1 和 K2。小红用其中一个加密文本，小明可以
用另一个解密文本。比如，如果发送方用 K1 加密：

```
小红 : C = E(M, K1)
小明 : M = D(C, K2)
```

这样一来，双方中的一方（比如小红）可以生成 K1和K2，然后把其中一个（比
如K1）私藏，称为**私钥**；另一个（比如K2）公开，称为**公钥**。另一方
（比如小明）得到公钥之后，双方就可以通信。

可是然并卵，中间人还是可能截获公钥，然后自己弄一对秘钥（ķ1, ķ2），然后
告诉小明说 ķ2 是小红的公钥。这样中间人每次可以用截获的 K2 解密小红发给
小明的文本，修改了内容之后，再用 ķ1 加密了发出去；小明用 ķ2 解密接收了
错误的内容。


### 数字签名和 CA

为了帮主小明确定得到的公钥确实是小红的 K2，而不是中间人伪造的 ķ2，牛人
们利用非对称加密发明了**数字签名（digital signature）**技术。

数字签名的意思是：把小红的公钥（K1）和小红的ID（身份证号码）合称为小红
的**身份证申请（certificate signing request，CSR）**，然后找一个德高望
重的人（certificate authority，CA），比如是小亮，用自己的私钥（A2）加
密小红的 CSR，得到的密文被称为**数字签名（digital signature）**。然后
把 signature 和 CSR 的明文一起发布出去。这样的发布出去的内容，就是小红
的 **CA签署的身份证（CA signed certificate，CRT）**。

```
小红：CSR = 小红公钥+小红身份证号
     signature = E(CSR, A2)
     CRT = CSR + signature
```

注意，因为A2是私钥，小亮不会公开。所以上述过程实际上是，小红把自己的
CSR给了小亮，小亮负责签署，然后把自己签署的小红的身份证（CRT）发给小红。

拿到这个身份证的人，不管是中间人还是小明还是其他人，都可以用小亮的公钥
（A1）解开其中的signature，从而验证解密结果和身份证里的CSR明文是否一致。
如果一致，则说明“这个小红的身份证是小亮签署的”。

```
小明：CSR' = D(CRT.signature, A1)
     if CSR' == CRT.CSR then OK
```

这里我们可以看到，随便谁都可以当CA——只要愿意公开自己的公钥，即可用自己
的私钥去加密别人的认证。那我们要是信错了 CA，被他摆我们一道怎么办？没
办法。我们要相信社会，要相信如果 CA 说谎，万一被识破，就没有人再相信他
了。现实中，很多操作系统（Windows、Mac OS X）和浏览器（Chrome、Mozilla、
IE）都会内置一些靠谱的 CA 的认证。但是有没有 CA 冒天下大不违说谎呢？不
知道。据传说有一个自称 CNNIC 的机构就说过谎。

### 信任链

为了做CA，小亮只需要公开自己的公钥就好了。但是可能没人信小亮（就像没人
信CNNIC一样）。小亮为了让人家相信他是个好CA，最好找一个大家都信的人，
比如老王，用老王的私钥 A'2 来认证小亮的身份：

```
小亮：CSR = 小亮的公钥+小亮身份证号码
     signature = E(CSR, A'2)
     CRT = CSR + signature
```

其中 A'2 是老王的私钥。如果浏览器或者操作系统里安装了老王的公钥 A'2，
则可以验证“小亮的身份证是老王签署的”。

这样小亮在签署小红的身份证的时候，可以在小红身份证后面附上自己的身份证。这样身份证就有“两页”了。
